\doxysection{utils.\+h File Reference}
\label{utils_8h}\index{utils.h@{utils.h}}


Utility functions declaration.  


{\ttfamily \#include \char`\"{}globals.\+h\char`\"{}}\newline
{\ttfamily \#include $<$math.\+h$>$}\newline
Include dependency graph for utils.\+h\+:
% FIG 0
This graph shows which files directly or indirectly include this file\+:
% FIG 1
\doxysubsection*{Macros}
\begin{DoxyCompactItemize}
\item 
\#define \textbf{ ZMAX}~5
\item 
\#define \textbf{ ZERO\+\_\+\+TOL}~100
\item 
\#define \textbf{ REFSPEED}~20
\item 
\#define \textbf{ SIGN}(A)~(((A) $>$=0) ? (1) \+: (-\/1))
\end{DoxyCompactItemize}
\doxysubsection*{Functions}
\begin{Indent}\textbf{ Filters}\par
\begin{DoxyCompactItemize}
\item 
int32 \textbf{ filter} (int32 value, struct \textbf{ st\+\_\+filter} $\ast$f)
\end{DoxyCompactItemize}
\end{Indent}
\begin{Indent}\textbf{ Estimating current and difference}\par
\begin{DoxyCompactItemize}
\item 
int32 \textbf{ curr\+\_\+estim} (uint8 idx, int32 pos, int32 vel, int32 acc)
\end{DoxyCompactItemize}
\end{Indent}
\begin{Indent}\textbf{ Utility functions}\par
\begin{DoxyCompactItemize}
\item 
uint32 \textbf{ my\+\_\+mod} (int32 val, int32 divisor)
\item 
int \textbf{ calc\+\_\+turns\+\_\+fcn\+\_\+\+SH} (const int32 pos1, const int32 pos2, const int N1, const int N2, const int I1)
\item 
int \textbf{ calc\+\_\+turns\+\_\+fcn} (const int32 pos1, const int32 pos2, const int N1, const int N2, const int I1)
\item 
void \textbf{ calibration} ()
\item 
void \textbf{ check\+\_\+rest\+\_\+position} ()
\item 
void \textbf{ LED\+\_\+control} (uint8 mode)
\item 
\mbox{\label{utils_8h_ae7eac41344d5679b9f7624357a88119d}} 
void {\bfseries battery\+\_\+management} ()
\item 
\mbox{\label{utils_8h_a1bea2981fd56850186356ea344e07e42}} 
void {\bfseries ADC\+\_\+\+Set\+\_\+\+N\+\_\+\+Channels} ()
\item 
\mbox{\label{utils_8h_a60ad0d7249bf56336e0908eaeec604e8}} 
void {\bfseries enable\+\_\+motor} (uint8 idx, uint8 val)
\item 
void \textbf{ reset\+\_\+counters} ()
\item 
\mbox{\label{utils_8h_a5e5346796220b271615a52428f6ec6ca}} 
float {\bfseries inv\+Sqrt} (float x)
\item 
\mbox{\label{utils_8h_a88d150c696b69e576a1dfb193266ae6a}} 
void {\bfseries v3\+\_\+normalize} (float v3\+\_\+in[3])
\item 
\mbox{\label{utils_8h_a2965058da02ba33e26af00cff2fcfec2}} 
void {\bfseries v4\+\_\+normalize} (float v4\+\_\+in[4])
\item 
void \textbf{ update\+\_\+\+EMG\+\_\+history} ()
\item 
\mbox{\label{utils_8h_a9b8b6ca7027bc3165c8786ae6d13f366}} 
void {\bfseries set\+\_\+motor\+\_\+driver\+\_\+type} ()
\end{DoxyCompactItemize}
\end{Indent}


\doxysubsection{Detailed Description}
Utility functions declaration. 

\begin{DoxyDate}{Date}
March 20th, 2020 
\end{DoxyDate}
\begin{DoxyAuthor}{Author}
{\itshape Centro \char`\"{}\+E.\+Piaggio\char`\"{}} 
\end{DoxyAuthor}
\begin{DoxyCopyright}{Copyright}
(C) 2012-\/2016 qbrobotics. All rights reserved. 

(C) 2017-\/2020 Centro \char`\"{}\+E.\+Piaggio\char`\"{}. All rights reserved. 
\end{DoxyCopyright}


\doxysubsection{Macro Definition Documentation}
\mbox{\label{utils_8h_a398d0c26e6af88fbdc96f871b7c3495e}} 
\index{utils.h@{utils.h}!REFSPEED@{REFSPEED}}
\index{REFSPEED@{REFSPEED}!utils.h@{utils.h}}
\doxysubsubsection{REFSPEED}
{\footnotesize\ttfamily \#define REFSPEED~20}

Constant depending on PID values. \mbox{\label{utils_8h_a8c7db0cde6d591a5abad279ba92ef021}} 
\index{utils.h@{utils.h}!SIGN@{SIGN}}
\index{SIGN@{SIGN}!utils.h@{utils.h}}
\doxysubsubsection{SIGN}
{\footnotesize\ttfamily \#define SIGN(\begin{DoxyParamCaption}\item[{}]{A }\end{DoxyParamCaption})~(((A) $>$=0) ? (1) \+: (-\/1))}

Sign calculation function. \mbox{\label{utils_8h_a2d55df83bcb11e53743ff6732e4bf7c1}} 
\index{utils.h@{utils.h}!ZERO\_TOL@{ZERO\_TOL}}
\index{ZERO\_TOL@{ZERO\_TOL}!utils.h@{utils.h}}
\doxysubsubsection{ZERO\_TOL}
{\footnotesize\ttfamily \#define ZERO\+\_\+\+TOL~100}

Deadband used to put to zero the virtual position due to the fact that the friction model has errors when the position is near to zero. \mbox{\label{utils_8h_a131010b0d7e64a592f782aec28c6a4d8}} 
\index{utils.h@{utils.h}!ZMAX@{ZMAX}}
\index{ZMAX@{ZMAX}!utils.h@{utils.h}}
\doxysubsubsection{ZMAX}
{\footnotesize\ttfamily \#define ZMAX~5}

Constant useful for current estimation procedure. 

\doxysubsection{Function Documentation}
\mbox{\label{utils_8h_ae7dc9eeaef91416fa3a148612ed75bf7}} 
\index{utils.h@{utils.h}!calc\_turns\_fcn@{calc\_turns\_fcn}}
\index{calc\_turns\_fcn@{calc\_turns\_fcn}!utils.h@{utils.h}}
\doxysubsubsection{calc\_turns\_fcn()}
{\footnotesize\ttfamily int calc\+\_\+turns\+\_\+fcn (\begin{DoxyParamCaption}\item[{const int32}]{pos1,  }\item[{const int32}]{pos2,  }\item[{const int}]{N1,  }\item[{const int}]{N2,  }\item[{const int}]{I1 }\end{DoxyParamCaption})}

This function is used at startup to reconstruct the correct turn of the shaft connected to the motor. Generic. It need two encoders to work.


\begin{DoxyParams}{Parameters}
{\em pos1} & First encoder position \\
\hline
{\em pos2} & Second encoder position\\
\hline
\end{DoxyParams}
\begin{DoxyReturn}{Returns}
Returns the number of turns of motor pulley at startup 
\end{DoxyReturn}
\mbox{\label{utils_8h_a73109b827d86a6936e0ca361d82d6328}} 
\index{utils.h@{utils.h}!calc\_turns\_fcn\_SH@{calc\_turns\_fcn\_SH}}
\index{calc\_turns\_fcn\_SH@{calc\_turns\_fcn\_SH}!utils.h@{utils.h}}
\doxysubsubsection{calc\_turns\_fcn\_SH()}
{\footnotesize\ttfamily int calc\+\_\+turns\+\_\+fcn\+\_\+\+SH (\begin{DoxyParamCaption}\item[{const int32}]{pos1,  }\item[{const int32}]{pos2,  }\item[{const int}]{N1,  }\item[{const int}]{N2,  }\item[{const int}]{I1 }\end{DoxyParamCaption})}

This function is used at startup to reconstruct the correct turn of the shaft connected to the motor. Only for Soft\+Hand 3.\+0. It need two encoders to work.


\begin{DoxyParams}{Parameters}
{\em pos1} & First encoder position \\
\hline
{\em pos2} & Second encoder position\\
\hline
\end{DoxyParams}
\begin{DoxyReturn}{Returns}
Returns the number of turns of motor pulley at startup 
\end{DoxyReturn}
\mbox{\label{utils_8h_a6d9dc88d64cd1f74a30fd0e404a3bb31}} 
\index{utils.h@{utils.h}!calibration@{calibration}}
\index{calibration@{calibration}!utils.h@{utils.h}}
\doxysubsubsection{calibration()}
{\footnotesize\ttfamily void calibration (\begin{DoxyParamCaption}{ }\end{DoxyParamCaption})}

This function counts a series of hand opening and closing used to execute a calibration of the device. \mbox{\label{utils_8h_a2cb024aea0170c085d18670f5a851df8}} 
\index{utils.h@{utils.h}!check\_rest\_position@{check\_rest\_position}}
\index{check\_rest\_position@{check\_rest\_position}!utils.h@{utils.h}}
\doxysubsubsection{check\_rest\_position()}
{\footnotesize\ttfamily void check\+\_\+rest\+\_\+position (\begin{DoxyParamCaption}{ }\end{DoxyParamCaption})}

This function checks for rest position and, in case, gives a position reference to Soft\+Hand. \mbox{\label{utils_8h_a284a90898751a15b0303f688f19948b9}} 
\index{utils.h@{utils.h}!curr\_estim@{curr\_estim}}
\index{curr\_estim@{curr\_estim}!utils.h@{utils.h}}
\doxysubsubsection{curr\_estim()}
{\footnotesize\ttfamily int32 curr\+\_\+estim (\begin{DoxyParamCaption}\item[{uint8}]{idx,  }\item[{int32}]{pos,  }\item[{int32}]{vel,  }\item[{int32}]{acc }\end{DoxyParamCaption})}

Function used to obtain current estimation through current lookup table.


\begin{DoxyParams}{Parameters}
{\em idx} & Index of motor. \\
\hline
{\em pos} & Position of the encoder in ticks. \\
\hline
{\em vel} & Speed of the encoder. \\
\hline
{\em accel} & Acceleration of the encoder\\
\hline
\end{DoxyParams}
\begin{DoxyReturn}{Returns}
Returns an estimation of the motor current, depending on its position, velocity and acceleration. 
\end{DoxyReturn}
\mbox{\label{utils_8h_aa404d0e01f2ab2318d323c7ef8fa6c5a}} 
\index{utils.h@{utils.h}!filter@{filter}}
\index{filter@{filter}!utils.h@{utils.h}}
\doxysubsubsection{filter()}
{\footnotesize\ttfamily int32 filter (\begin{DoxyParamCaption}\item[{int32}]{value,  }\item[{struct \textbf{ st\+\_\+filter} $\ast$}]{f }\end{DoxyParamCaption})}

Generic low pass filter. The weighted average between the old value and the new one is executed.


\begin{DoxyParams}{Parameters}
{\em value} & New value of the filter. \\
\hline
{\em f} & Pointer to specific struct of type \doxyref{st\+\_\+filter}{p.}{structst__filter}. ~\newline
\\
\hline
\end{DoxyParams}
\begin{DoxyReturn}{Returns}
Returns the filtered current value 
\end{DoxyReturn}
\mbox{\label{utils_8h_a4443e9a681f8c13d317110b8017136c8}} 
\index{utils.h@{utils.h}!LED\_control@{LED\_control}}
\index{LED\_control@{LED\_control}!utils.h@{utils.h}}
\doxysubsubsection{LED\_control()}
{\footnotesize\ttfamily void LED\+\_\+control (\begin{DoxyParamCaption}\item[{uint8}]{mode }\end{DoxyParamCaption})}

This function switches between different LEDs condition depending on battery level of charge or needed maintenance. \mbox{\label{utils_8h_a01d3bb6c1fd469a6c530fb296e4fe0fe}} 
\index{utils.h@{utils.h}!my\_mod@{my\_mod}}
\index{my\_mod@{my\_mod}!utils.h@{utils.h}}
\doxysubsubsection{my\_mod()}
{\footnotesize\ttfamily uint32 my\+\_\+mod (\begin{DoxyParamCaption}\item[{int32}]{val,  }\item[{int32}]{divisor }\end{DoxyParamCaption})}

This function computes the module function, returning positive values regardless of wheter the value passed is negative


\begin{DoxyParams}{Parameters}
{\em val} & The value of which the module needs to be calculated \\
\hline
{\em divisor} & The divisor according to which the module is calculated \\
\hline
\end{DoxyParams}
\mbox{\label{utils_8h_a2640efff1e7b6f9c11615048ba43b0fd}} 
\index{utils.h@{utils.h}!reset\_counters@{reset\_counters}}
\index{reset\_counters@{reset\_counters}!utils.h@{utils.h}}
\doxysubsubsection{reset\_counters()}
{\footnotesize\ttfamily void reset\+\_\+counters (\begin{DoxyParamCaption}{ }\end{DoxyParamCaption})}

This function reset statistics counters \mbox{\label{utils_8h_aadf16dc795c83780e5b9eb5c2c5680b0}} 
\index{utils.h@{utils.h}!update\_EMG\_history@{update\_EMG\_history}}
\index{update\_EMG\_history@{update\_EMG\_history}!utils.h@{utils.h}}
\doxysubsubsection{update\_EMG\_history()}
{\footnotesize\ttfamily void update\+\_\+\+EMG\+\_\+history (\begin{DoxyParamCaption}{ }\end{DoxyParamCaption})}

This function updates the EMG history values with last availables. 